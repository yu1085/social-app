# å¤´åƒä¸Šä¼ åŠŸèƒ½æµ‹è¯•æŒ‡å—

## åŠŸèƒ½æ¦‚è¿°

å·²å®Œæˆå¤´åƒä¸Šä¼ å’Œæ˜¾ç¤ºåŠŸèƒ½çš„å®ç°ï¼ŒåŒ…æ‹¬ï¼š
1. **åç«¯API**ï¼šå¤´åƒæ–‡ä»¶ä¸Šä¼ ã€å›¾ç‰‡éªŒè¯ã€æ–‡ä»¶å­˜å‚¨
2. **Androidå®¢æˆ·ç«¯**ï¼šå›¾ç‰‡é€‰æ‹©ã€å‹ç¼©ã€ä¸Šä¼ ã€æ˜¾ç¤º

---

## åç«¯å®ç°

### 1. æ–‡ä»¶ä¸Šä¼ é…ç½®
- **ä½ç½®**ï¼š`backend/src/main/java/com/socialmeet/backend/config/FileUploadConfig.java`
- **åŠŸèƒ½**ï¼š
  - é…ç½®ä¸Šä¼ ç›®å½•ï¼š`uploads/avatars/`
  - é…ç½®é™æ€èµ„æºæ˜ å°„ï¼Œä½¿ä¸Šä¼ çš„æ–‡ä»¶å¯é€šè¿‡HTTPè®¿é—®
  - è‡ªåŠ¨åˆ›å»ºä¸Šä¼ ç›®å½•

### 2. æ–‡ä»¶ä¸Šä¼ æœåŠ¡
- **ä½ç½®**ï¼š`backend/src/main/java/com/socialmeet/backend/service/FileUploadService.java`
- **åŠŸèƒ½**ï¼š
  - éªŒè¯å›¾ç‰‡æ ¼å¼ï¼ˆjpg, jpeg, png, gif, bmp, webpï¼‰
  - é™åˆ¶æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§5MBï¼‰
  - ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼ˆavatar_userId_timestamp_uuid.extï¼‰
  - ä¿å­˜æ–‡ä»¶å¹¶è¿”å›è®¿é—®URL
  - åˆ é™¤æ—§å¤´åƒæ–‡ä»¶

### 3. å¤´åƒä¸Šä¼ API
- **æ¥å£**ï¼š`POST /api/profile/upload-avatar`
- **è¯·æ±‚å¤´**ï¼š`Authorization: Bearer {token}`
- **è¯·æ±‚ä½“**ï¼š`multipart/form-data` (fileå­—æ®µ)
- **å“åº”**ï¼š
```json
{
  "success": true,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "avatarUrl": "http://localhost:8080/uploads/avatars/avatar_1_20250120123456_abc123.jpg"
  }
}
```

---

## Androidå®ç°

### 1. å¤´åƒä¸Šä¼ æœåŠ¡
- **ä½ç½®**ï¼š`app/src/main/java/com/example/myapplication/service/AvatarUploadService.kt`
- **åŠŸèƒ½**ï¼š
  - å›¾ç‰‡å‹ç¼©ï¼ˆæœ€å¤§1024x1024ï¼‰
  - EXIFæ—‹è½¬å¤„ç†
  - JPEGè´¨é‡å‹ç¼©ï¼ˆ85%ï¼‰
  - åˆ›å»ºMultipartè¯·æ±‚ä½“
  - ä¸´æ—¶æ–‡ä»¶ç®¡ç†

### 2. APIæ¥å£
- **ä½ç½®**ï¼š`app/src/main/java/com/example/myapplication/network/ApiService.java`
- **æ–¹æ³•**ï¼š
```java
@Multipart
@POST("profile/upload-avatar")
Call<ApiResponse<Map<String, String>>> uploadAvatar(
    @Header("Authorization") String authHeader,
    @Part MultipartBody.Part file
);
```

### 3. UIå®ç°
- **ä½ç½®**ï¼š`app/src/main/java/com/example/myapplication/MyProfileEditActivity.kt`
- **åŠŸèƒ½**ï¼š
  - åœ†å½¢å¤´åƒæ˜¾ç¤ºï¼ˆä½¿ç”¨CoilåŠ è½½ï¼‰
  - ç‚¹å‡»å¤´åƒé€‰æ‹©å›¾ç‰‡
  - ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
  - ç¼–è¾‘æŒ‰é’®å›¾æ ‡
  - å®æ—¶æ›´æ–°å¤´åƒ

---

## æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd backend
../gradlew clean build
java -jar build/libs/backend-0.0.1-SNAPSHOT.jar
```

æˆ–ä½¿ç”¨PowerShellè„šæœ¬ï¼š
```powershell
.\start_backend_with_profile.ps1
```

### 2. éªŒè¯åç«¯é…ç½®

æ£€æŸ¥ `backend/src/main/resources/application.yml`ï¼š
```yaml
spring:
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 20MB
      enabled: true

file:
  upload:
    path: uploads/
    avatar-path: uploads/avatars/

server:
  host: localhost
```

### 3. æ„å»ºAndroidåº”ç”¨

```bash
gradlew :app:assembleDebug
```

### 4. åœ¨Androidæ¨¡æ‹Ÿå™¨/çœŸæœºä¸Šæµ‹è¯•

#### æ­¥éª¤ Aï¼šç™»å½•åº”ç”¨
1. å¯åŠ¨åº”ç”¨
2. è¾“å…¥æ‰‹æœºå·ç™»å½•ï¼ˆæµ‹è¯•æ¨¡å¼éªŒè¯ç ï¼š123456ï¼‰

#### æ­¥éª¤ Bï¼šè¿›å…¥èµ„æ–™ç¼–è¾‘é¡µé¢
1. è¿›å…¥"æˆ‘çš„"é¡µé¢
2. ç‚¹å‡»"ç¼–è¾‘èµ„æ–™"æˆ–"æˆ‘çš„èµ„æ–™"

#### æ­¥éª¤ Cï¼šä¸Šä¼ å¤´åƒ
1. ç‚¹å‡»åœ†å½¢å¤´åƒåŒºåŸŸ
2. ä»ç›¸å†Œé€‰æ‹©å›¾ç‰‡
3. ç­‰å¾…ä¸Šä¼ ï¼ˆæ˜¾ç¤ºä¸Šä¼ è¿›åº¦ï¼‰
4. ä¸Šä¼ æˆåŠŸåï¼Œå¤´åƒè‡ªåŠ¨æ›´æ–°

#### æ­¥éª¤ Dï¼šéªŒè¯å¤´åƒæ˜¾ç¤º
1. è¿”å›ä¸ªäººä¸­å¿ƒï¼ŒæŸ¥çœ‹å¤´åƒæ˜¯å¦æ›´æ–°
2. é‡æ–°è¿›å…¥èµ„æ–™ç¼–è¾‘é¡µé¢ï¼ŒéªŒè¯å¤´åƒæŒä¹…åŒ–
3. é€€å‡ºé‡æ–°ç™»å½•ï¼ŒéªŒè¯å¤´åƒä»ç„¶æ˜¾ç¤º

---

## æµ‹è¯•ç”¨ä¾‹

### åŠŸèƒ½æµ‹è¯•

| æµ‹è¯•é¡¹ | æµ‹è¯•æ­¥éª¤ | é¢„æœŸç»“æœ |
|--------|----------|----------|
| é€‰æ‹©å›¾ç‰‡ | ç‚¹å‡»å¤´åƒï¼Œä»ç›¸å†Œé€‰æ‹©å›¾ç‰‡ | å›¾ç‰‡é€‰æ‹©å™¨æ­£å¸¸æ‰“å¼€ |
| å›¾ç‰‡å‹ç¼© | é€‰æ‹©å¤§å›¾ç‰‡ï¼ˆ>5MBï¼‰ | è‡ªåŠ¨å‹ç¼©åˆ°åˆç†å¤§å° |
| ä¸Šä¼ è¿›åº¦ | ä¸Šä¼ å›¾ç‰‡ | æ˜¾ç¤ºåŠ è½½åŠ¨ç”» |
| ä¸Šä¼ æˆåŠŸ | ç­‰å¾…ä¸Šä¼ å®Œæˆ | Toastæç¤º"å¤´åƒä¸Šä¼ æˆåŠŸ"ï¼Œå¤´åƒæ›´æ–° |
| ä¸Šä¼ å¤±è´¥ | æ–­å¼€ç½‘ç»œä¸Šä¼  | æ˜¾ç¤ºé”™è¯¯æç¤ºå¯¹è¯æ¡† |
| å›¾ç‰‡æ ¼å¼ | ä¸Šä¼ ä¸åŒæ ¼å¼å›¾ç‰‡ | æ”¯æŒjpg, png, gif, webpç­‰æ ¼å¼ |
| å›¾ç‰‡æ—‹è½¬ | ä¸Šä¼ å¸¦EXIFæ—‹è½¬ä¿¡æ¯çš„å›¾ç‰‡ | è‡ªåŠ¨æ—‹è½¬åˆ°æ­£ç¡®æ–¹å‘ |
| å¤´åƒæ˜¾ç¤º | æŸ¥çœ‹ä¸ªäººä¸­å¿ƒ | å¤´åƒæ­£ç¡®æ˜¾ç¤º |
| æŒä¹…åŒ– | é‡å¯åº”ç”¨ | å¤´åƒä»ç„¶æ˜¾ç¤º |

### å¼‚å¸¸æµ‹è¯•

| æµ‹è¯•é¡¹ | æµ‹è¯•æ­¥éª¤ | é¢„æœŸç»“æœ |
|--------|----------|----------|
| æœªç™»å½• | æœªç™»å½•çŠ¶æ€ä¸Šä¼  | æç¤º"è¯·å…ˆç™»å½•" |
| Tokenè¿‡æœŸ | Tokenè¿‡æœŸåä¸Šä¼  | æç¤ºé‡æ–°ç™»å½• |
| ç½‘ç»œæ–­å¼€ | ä¸Šä¼ æ—¶æ–­ç½‘ | æ˜¾ç¤º"ç½‘ç»œé”™è¯¯"æç¤º |
| æ–‡ä»¶è¿‡å¤§ | ä¸Šä¼ >10MBæ–‡ä»¶ | åç«¯è¿”å›"æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB" |
| æ ¼å¼é”™è¯¯ | ä¸Šä¼ éå›¾ç‰‡æ–‡ä»¶ | åç«¯è¿”å›"ä¸æ”¯æŒçš„å›¾ç‰‡æ ¼å¼" |
| æœåŠ¡å™¨é”™è¯¯ | åç«¯æœåŠ¡æœªå¯åŠ¨ | æ˜¾ç¤º"ä¸Šä¼ å¤±è´¥"æç¤º |

---

## APIæµ‹è¯•ï¼ˆä½¿ç”¨Postmanæˆ–curlï¼‰

### 1. è·å–Token
```bash
curl -X POST http://localhost:8080/api/auth/send-code?phone=13800138000
curl -X POST http://localhost:8080/api/auth/login-with-code?phone=13800138000&code=123456
```

### 2. ä¸Šä¼ å¤´åƒ
```bash
curl -X POST http://localhost:8080/api/profile/upload-avatar \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@/path/to/image.jpg"
```

### 3. éªŒè¯å¤´åƒURL
è®¿é—®è¿”å›çš„avatarUrlï¼ŒéªŒè¯å›¾ç‰‡æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®ï¼š
```
http://localhost:8080/uploads/avatars/avatar_1_20250120123456_abc123.jpg
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šä¸Šä¼ å¤±è´¥ï¼Œæç¤º"æœªæä¾›æœ‰æ•ˆçš„è®¤è¯ä»¤ç‰Œ"
**åŸå› **ï¼šTokenæ— æ•ˆæˆ–æœªç™»å½•
**è§£å†³**ï¼š
1. æ£€æŸ¥AuthManagerä¸­çš„Tokenæ˜¯å¦æœ‰æ•ˆ
2. é‡æ–°ç™»å½•è·å–æ–°Token

### é—®é¢˜2ï¼šä¸Šä¼ åå›¾ç‰‡æ— æ³•è®¿é—®
**åŸå› **ï¼šé™æ€èµ„æºæ˜ å°„æœªç”Ÿæ•ˆ
**è§£å†³**ï¼š
1. æ£€æŸ¥FileUploadConfigé…ç½®
2. ç¡®è®¤uploadsç›®å½•å·²åˆ›å»º
3. é‡å¯åç«¯æœåŠ¡

### é—®é¢˜3ï¼šå›¾ç‰‡ä¸Šä¼ å¾ˆæ…¢
**åŸå› **ï¼šå›¾ç‰‡æœªå‹ç¼©æˆ–ç½‘ç»œæ…¢
**è§£å†³**ï¼š
1. AvatarUploadServiceå·²å®ç°è‡ªåŠ¨å‹ç¼©
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å‹ç¼©æ˜¯å¦ç”Ÿæ•ˆ

### é—®é¢˜4ï¼šå¤´åƒæ˜¾ç¤ºä¸ºç©ºç™½
**åŸå› **ï¼šCoilæ— æ³•åŠ è½½å›¾ç‰‡
**è§£å†³**ï¼š
1. æ£€æŸ¥avatarUrlæ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ç½‘ç»œæƒé™å·²æˆäºˆ
3. æŸ¥çœ‹Logcatä¸­çš„Coilæ—¥å¿—

---

## æ—¥å¿—æŸ¥çœ‹

### åç«¯æ—¥å¿—
å…³é”®æ—¥å¿—æ ‡ç­¾ï¼š
- `FileUploadService` - æ–‡ä»¶ä¸Šä¼ ç›¸å…³
- `ProfileController` - å¤´åƒä¸Šä¼ API
- `ProfileService` - ç”¨æˆ·èµ„æ–™æ›´æ–°

### Androidæ—¥å¿—
å…³é”®æ—¥å¿—æ ‡ç­¾ï¼š
```bash
adb logcat | grep -E "AvatarUpload|ProfileEdit"
```

æ—¥å¿—ç¤ºä¾‹ï¼š
```
AvatarUpload: å¼€å§‹å‡†å¤‡å¤´åƒæ–‡ä»¶
AvatarUpload: åŸå§‹å›¾ç‰‡å°ºå¯¸: 4000x3000
AvatarUpload: å‹ç¼©å›¾ç‰‡: 4000x3000 -> 1024x768
AvatarUpload: å›¾ç‰‡æ–‡ä»¶å‡†å¤‡å®Œæˆ: /data/user/0/.../avatar_1234567890.jpg, å¤§å°: 256KB
AvatarUpload: å¤´åƒä¸Šä¼ æˆåŠŸ: http://localhost:8080/uploads/avatars/...
ProfileEdit: å¤´åƒä¸Šä¼ æˆåŠŸï¼Œæ›´æ–°userProfile
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å·²å®ç°çš„ä¼˜åŒ–
1. âœ… å›¾ç‰‡è‡ªåŠ¨å‹ç¼©ï¼ˆæœ€å¤§1024x1024ï¼‰
2. âœ… JPEGè´¨é‡å‹ç¼©ï¼ˆ85%ï¼‰
3. âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†
4. âœ… å¼‚æ­¥ä¸Šä¼ ï¼ˆä¸é˜»å¡UIï¼‰

### æœªæ¥å¯ä»¥ä¼˜åŒ–
1. å›¾ç‰‡è£å‰ªåŠŸèƒ½ï¼ˆæ­£æ–¹å½¢è£å‰ªï¼‰
2. ç¼“å­˜å¤´åƒåˆ°æœ¬åœ°
3. æ”¯æŒæ‹ç…§ä¸Šä¼ 
4. å¤šå¤´åƒç®¡ç†ï¼ˆç›¸å†ŒåŠŸèƒ½ï¼‰
5. CDNé›†æˆï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

---

## æ€»ç»“

âœ… **å·²å®ŒæˆåŠŸèƒ½**ï¼š
- åç«¯å¤´åƒä¸Šä¼ API
- æ–‡ä»¶éªŒè¯å’Œå­˜å‚¨
- Androidå›¾ç‰‡é€‰æ‹©å’Œå‹ç¼©
- å¤´åƒä¸Šä¼ å’Œæ˜¾ç¤ºUI
- å®æ—¶æ›´æ–°å¤´åƒ

ğŸ”„ **æµ‹è¯•çŠ¶æ€**ï¼šå¾…æµ‹è¯•

ğŸ“ **ä¸‹ä¸€æ­¥**ï¼š
1. è¿è¡Œåç«¯æœåŠ¡
2. å®‰è£…Androidåº”ç”¨
3. æŒ‰ç…§æµ‹è¯•æ­¥éª¤éªŒè¯åŠŸèƒ½
4. æ ‡è®°ä»»åŠ¡å®Œæˆ
