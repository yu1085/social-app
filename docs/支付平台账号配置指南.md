# æ”¯ä»˜å¹³å°è´¦å·é…ç½®æŒ‡å—

## ğŸ¯ æ¦‚è¿°

æœ¬æŒ‡å—å°†è¯¦ç»†è¯´æ˜å¦‚ä½•ç”³è¯·å’Œé…ç½®æ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜çš„çœŸå®å•†æˆ·è´¦å·ï¼Œä»¥åŠåœ¨åº”ç”¨ä¸­è¿›è¡Œç›¸å…³é…ç½®ã€‚

## ğŸ’° æ”¯ä»˜å®å•†æˆ·è´¦å·ç”³è¯·

### 1. ç”³è¯·æ”¯ä»˜å®å¼€å‘è€…è´¦å·

#### 1.1 æ³¨å†Œå¼€æ”¾å¹³å°è´¦å·
1. è®¿é—® [æ”¯ä»˜å®å¼€æ”¾å¹³å°](https://open.alipay.com/)
2. ç‚¹å‡»"ç«‹å³å…¥é©»" â†’ "å¼€å‘è€…å…¥é©»"
3. ä½¿ç”¨æ”¯ä»˜å®è´¦å·ç™»å½•
4. å®Œæˆå¼€å‘è€…è®¤è¯ï¼ˆä¸ªäººæˆ–ä¼ä¸šï¼‰

#### 1.2 åˆ›å»ºåº”ç”¨
1. ç™»å½•å¼€æ”¾å¹³å°æ§åˆ¶å°
2. ç‚¹å‡»"åˆ›å»ºåº”ç”¨" â†’ "ç§»åŠ¨åº”ç”¨"
3. å¡«å†™åº”ç”¨ä¿¡æ¯ï¼š
   - **åº”ç”¨åç§°**: SocialMeet
   - **åº”ç”¨ç®€ä»‹**: ç¤¾äº¤èŠå¤©åº”ç”¨
   - **åº”ç”¨ç±»å‹**: Androidåº”ç”¨
   - **åº”ç”¨åŒ…å**: com.example.myapplication

#### 1.3 é…ç½®åº”ç”¨ä¿¡æ¯
```
åº”ç”¨åŸºæœ¬ä¿¡æ¯ï¼š
- åº”ç”¨å›¾æ ‡: ä¸Šä¼ åº”ç”¨å›¾æ ‡
- åº”ç”¨æˆªå›¾: ä¸Šä¼ åº”ç”¨æˆªå›¾
- éšç§æ”¿ç­–: æä¾›éšç§æ”¿ç­–é“¾æ¥
- ç”¨æˆ·åè®®: æä¾›ç”¨æˆ·åè®®é“¾æ¥
```

### 2. è·å–æ”¯ä»˜å®å¯†é’¥ä¿¡æ¯

#### 2.1 ç”Ÿæˆåº”ç”¨å¯†é’¥å¯¹
```bash
# ä½¿ç”¨æ”¯ä»˜å®å¯†é’¥ç”Ÿæˆå·¥å…·
# ä¸‹è½½åœ°å€: https://opendocs.alipay.com/common/02kipl

# æˆ–ä½¿ç”¨OpenSSLç”Ÿæˆ
openssl genrsa -out alipay_private_key.pem 2048
openssl rsa -in alipay_private_key.pem -pubout -out alipay_public_key.pem

# è½¬æ¢ä¸ºPKCS#8æ ¼å¼
openssl pkcs8 -topk8 -inform PEM -in alipay_private_key.pem -outform PEM -nocrypt -out alipay_private_key_pkcs8.pem
```

#### 2.2 ä¸Šä¼ å…¬é’¥åˆ°æ”¯ä»˜å®
1. åœ¨åº”ç”¨è¯¦æƒ…é¡µé¢æ‰¾åˆ°"å¼€å‘è®¾ç½®"
2. ç‚¹å‡»"æ¥å£åŠ ç­¾æ–¹å¼" â†’ "å…¬é’¥"
3. ä¸Šä¼ åˆšç”Ÿæˆçš„å…¬é’¥æ–‡ä»¶å†…å®¹
4. ä¿å­˜åè·å¾—"æ”¯ä»˜å®å…¬é’¥"

#### 2.3 è®°å½•é‡è¦ä¿¡æ¯
```
éœ€è¦è®°å½•çš„ä¿¡æ¯ï¼š
- APPID: 2021001234567890 (ç¤ºä¾‹)
- åº”ç”¨ç§é’¥: MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwgg...
- æ”¯ä»˜å®å…¬é’¥: MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
```

### 3. å¼€é€šæ‰‹æœºç½‘ç«™æ”¯ä»˜åŠŸèƒ½

#### 3.1 ç”³è¯·åŠŸèƒ½
1. åœ¨åº”ç”¨ç®¡ç†é¡µé¢ç‚¹å‡»"æ·»åŠ åŠŸèƒ½"
2. é€‰æ‹©"æ‰‹æœºç½‘ç«™æ”¯ä»˜"æˆ–"APPæ”¯ä»˜"
3. å¡«å†™ç›¸å…³èµ„æ–™å¹¶æäº¤å®¡æ ¸

#### 3.2 é…ç½®å›è°ƒåœ°å€
```
å¼‚æ­¥é€šçŸ¥åœ°å€: https://yourdomain.com/api/recharge/callback/alipay
åŒæ­¥è·³è½¬åœ°å€: https://yourdomain.com/api/recharge/return/alipay
```

## ğŸ’¬ å¾®ä¿¡æ”¯ä»˜å•†æˆ·è´¦å·ç”³è¯·

### 1. ç”³è¯·å¾®ä¿¡æ”¯ä»˜å•†æˆ·å·

#### 1.1 æ³¨å†Œå¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°
1. è®¿é—® [å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°](https://pay.weixin.qq.com/)
2. ç‚¹å‡»"ç«‹å³æ³¨å†Œ"
3. é€‰æ‹©"å°å¾®å•†æˆ·" æˆ– "æ™®é€šå•†æˆ·"ï¼ˆæ ¹æ®ä¸šåŠ¡è§„æ¨¡ï¼‰

#### 1.2 æäº¤èµ„æ–™
```
æ‰€éœ€èµ„æ–™ï¼š
- è¥ä¸šæ‰§ç…§ï¼ˆä¼ä¸šï¼‰æˆ–èº«ä»½è¯ï¼ˆä¸ªäººï¼‰
- é“¶è¡Œå¼€æˆ·è®¸å¯è¯
- æ³•äººèº«ä»½è¯
- ç»“ç®—é“¶è¡Œå¡
- é—¨åº—ç…§ç‰‡ï¼ˆå¦‚é€‚ç”¨ï¼‰
```

#### 1.3 ç­¾ç½²åè®®å¹¶ç¼´è´¹
- åœ¨çº¿ç­¾ç½²ã€Šå¾®ä¿¡æ”¯ä»˜æœåŠ¡åè®®ã€‹
- ç¼´çº³ä¿è¯é‡‘ï¼ˆé€šå¸¸300å…ƒï¼Œä¸ªäººå•†æˆ·å¯èƒ½å…ç¼´ï¼‰

### 2. è·å–å¾®ä¿¡æ”¯ä»˜é…ç½®ä¿¡æ¯

#### 2.1 è·å–å•†æˆ·å·ä¿¡æ¯
```
å®¡æ ¸é€šè¿‡åè·å¾—ï¼š
- å•†æˆ·å·(mch_id): 1234567890
- å•†æˆ·APIå¯†é’¥: 32ä½å­—ç¬¦ä¸²
```

#### 2.2 è®¾ç½®APIå¯†é’¥
1. ç™»å½•å•†æˆ·å¹³å°
2. è¿›å…¥"è´¦æˆ·ä¸­å¿ƒ" â†’ "APIå®‰å…¨"
3. è®¾ç½®32ä½APIå¯†é’¥ï¼ˆç”¨äºç­¾åï¼‰

#### 2.3 ä¸‹è½½è¯ä¹¦æ–‡ä»¶
1. åœ¨"APIå®‰å…¨"é¡µé¢ä¸‹è½½å•†æˆ·è¯ä¹¦
2. è·å¾—ä»¥ä¸‹æ–‡ä»¶ï¼š
   - apiclient_cert.p12 (å•†æˆ·è¯ä¹¦)
   - apiclient_cert.pem (å•†æˆ·è¯ä¹¦)
   - apiclient_key.pem (å•†æˆ·ç§é’¥)

### 3. ç”³è¯·å¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·

#### 3.1 æ³¨å†Œå¼€å‘è€…è´¦å·
1. è®¿é—® [å¾®ä¿¡å¼€æ”¾å¹³å°](https://open.weixin.qq.com/)
2. æ³¨å†Œå¼€å‘è€…è´¦å·å¹¶å®Œæˆè®¤è¯
3. ç¼´çº³300å…ƒè®¤è¯è´¹ç”¨

#### 3.2 åˆ›å»ºç§»åŠ¨åº”ç”¨
1. ç‚¹å‡»"ç®¡ç†ä¸­å¿ƒ" â†’ "ç§»åŠ¨åº”ç”¨"
2. åˆ›å»ºåº”ç”¨å¹¶å¡«å†™ä¿¡æ¯ï¼š
   - **åº”ç”¨åç§°**: SocialMeet
   - **åº”ç”¨å¹³å°**: Android
   - **åº”ç”¨åŒ…å**: com.example.myapplication
   - **åº”ç”¨ç­¾å**: MD5å€¼

#### 3.3 ç”³è¯·å¾®ä¿¡æ”¯ä»˜åŠŸèƒ½
1. åœ¨åº”ç”¨è¯¦æƒ…é¡µç”³è¯·"å¾®ä¿¡æ”¯ä»˜"åŠŸèƒ½
2. å…³è”å·²ç”³è¯·çš„å•†æˆ·å·
3. ç­‰å¾…å®¡æ ¸é€šè¿‡

## âš™ï¸ åº”ç”¨é…ç½®

### 1. åç«¯é…ç½®

#### 1.1 åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶
```yaml
# SocialMeet/src/main/resources/application-prod.yml
spring:
  profiles:
    active: prod
  config:
    include: payment

# æ•°æ®åº“é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
  datasource:
    url: jdbc:mysql://your-prod-db:3306/socialmeet
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}

# æœåŠ¡å™¨é…ç½®
server:
  port: 8080
  servlet:
    context-path: /

# æ”¯ä»˜é…ç½®
payment:
  alipay:
    app-id: ${ALIPAY_APP_ID}
    private-key: ${ALIPAY_PRIVATE_KEY}
    alipay-public-key: ${ALIPAY_PUBLIC_KEY}
    server-url: https://openapi.alipay.com/gateway.do
    notify-url: https://yourdomain.com/api/recharge/callback/alipay
    return-url: https://yourdomain.com/api/recharge/return/alipay
    
  wechat:
    app-id: ${WECHAT_APP_ID}
    mch-id: ${WECHAT_MCH_ID}
    api-v3-key: ${WECHAT_API_V3_KEY}
    private-key-path: classpath:wechat_private_key.pem
    certificate-serial-number: ${WECHAT_CERT_SERIAL_NO}
    server-url: https://api.mch.weixin.qq.com
    notify-url: https://yourdomain.com/api/recharge/callback/wechat
```

#### 1.2 è®¾ç½®ç¯å¢ƒå˜é‡
```bash
# åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
# /etc/environment æˆ– ~/.bashrc

# æ”¯ä»˜å®é…ç½®
export ALIPAY_APP_ID="2021001234567890"
export ALIPAY_PRIVATE_KEY="MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwgg..."
export ALIPAY_PUBLIC_KEY="MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA..."

# å¾®ä¿¡æ”¯ä»˜é…ç½®
export WECHAT_APP_ID="wx1234567890abcdef"
export WECHAT_MCH_ID="1234567890"
export WECHAT_API_V3_KEY="your_32_character_api_v3_key_here"
export WECHAT_CERT_SERIAL_NO="1234567890ABCDEF"

# æ•°æ®åº“é…ç½®
export DB_USERNAME="your_db_user"
export DB_PASSWORD="your_db_password"

# æœåŠ¡å™¨åŸŸå
export SERVER_BASE_URL="https://yourdomain.com"
```

#### 1.3 æ”¾ç½®è¯ä¹¦æ–‡ä»¶
```bash
# åˆ›å»ºè¯ä¹¦ç›®å½•
mkdir -p SocialMeet/src/main/resources/certs

# æ”¾ç½®å¾®ä¿¡æ”¯ä»˜è¯ä¹¦
cp apiclient_key.pem SocialMeet/src/main/resources/wechat_private_key.pem
cp apiclient_cert.pem SocialMeet/src/main/resources/wechat_cert.pem

# è®¾ç½®æ–‡ä»¶æƒé™
chmod 600 SocialMeet/src/main/resources/*.pem
```

### 2. Androidç«¯é…ç½®

#### 2.1 æ·»åŠ æ”¯ä»˜SDKä¾èµ–
```kotlin
// app/build.gradle.kts
dependencies {
    // æ”¯ä»˜å®SDK
    implementation("com.alipay.sdk:alipay-sdk-android:15.8.11")
    
    // å¾®ä¿¡æ”¯ä»˜SDK
    implementation("com.tencent.mm.opensdk:wechat-sdk-android:6.8.0")
}
```

#### 2.2 é…ç½®AndroidManifest.xml
```xml
<!-- app/src/main/AndroidManifest.xml -->
<application>
    <!-- æ”¯ä»˜å®æ”¯ä»˜Activity -->
    <activity
        android:name="com.alipay.sdk.app.H5PayActivity"
        android:configChanges="orientation|keyboardHidden|navigation|screenSize"
        android:exported="false"
        android:screenOrientation="behind"
        android:windowSoftInputMode="adjustResize|stateHidden" />
    
    <activity
        android:name="com.alipay.sdk.app.H5AuthActivity"
        android:configChanges="orientation|keyboardHidden|navigation"
        android:exported="false"
        android:screenOrientation="behind"
        android:windowSoftInputMode="adjustResize|stateHidden" />
    
    <!-- å¾®ä¿¡æ”¯ä»˜Activity -->
    <activity
        android:name=".wxapi.WXPayEntryActivity"
        android:exported="true"
        android:launchMode="singleTop"
        android:theme="@android:style/Theme.Translucent.NoTitleBar" />
</application>

<!-- æƒé™ -->
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
<uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
```

#### 2.3 åˆ›å»ºå¾®ä¿¡æ”¯ä»˜å›è°ƒActivity
```kotlin
// app/src/main/java/com/example/myapplication/wxapi/WXPayEntryActivity.kt
package com.example.myapplication.wxapi

import android.app.Activity
import android.content.Intent
import android.os.Bundle
import com.tencent.mm.opensdk.constants.ConstantsAPI
import com.tencent.mm.opensdk.modelbase.BaseReq
import com.tencent.mm.opensdk.modelbase.BaseResp
import com.tencent.mm.opensdk.openapi.IWXAPI
import com.tencent.mm.opensdk.openapi.IWXAPIEventHandler
import com.tencent.mm.opensdk.openapi.WXAPIFactory

class WXPayEntryActivity : Activity(), IWXAPIEventHandler {
    
    private lateinit var api: IWXAPI
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        api = WXAPIFactory.createWXAPI(this, "your_wechat_app_id")
        api.handleIntent(intent, this)
    }
    
    override fun onNewIntent(intent: Intent?) {
        super.onNewIntent(intent)
        setIntent(intent)
        api.handleIntent(intent, this)
    }
    
    override fun onReq(req: BaseReq?) {
        // å¾®ä¿¡è¯·æ±‚å¤„ç†
    }
    
    override fun onResp(resp: BaseResp?) {
        if (resp?.type == ConstantsAPI.COMMAND_PAY_BY_WX) {
            // å¤„ç†æ”¯ä»˜ç»“æœ
            when (resp.errCode) {
                BaseResp.ErrCode.ERR_OK -> {
                    // æ”¯ä»˜æˆåŠŸ
                    setResult(RESULT_OK)
                }
                BaseResp.ErrCode.ERR_USER_CANCEL -> {
                    // ç”¨æˆ·å–æ¶ˆ
                    setResult(RESULT_CANCELED)
                }
                BaseResp.ErrCode.ERR_AUTH_DENIED -> {
                    // æ”¯ä»˜å¤±è´¥
                    setResult(RESULT_FIRST_USER)
                }
            }
        }
        finish()
    }
}
```

## ğŸ§ª æµ‹è¯•é…ç½®

### 1. æ²™ç®±ç¯å¢ƒæµ‹è¯•

#### 1.1 æ”¯ä»˜å®æ²™ç®±é…ç½®
```yaml
# application-dev.yml
payment:
  alipay:
    app-id: "æ²™ç®±åº”ç”¨APPID"
    server-url: https://openapi.alipaydev.com/gateway.do
    # ä½¿ç”¨æ²™ç®±å¯†é’¥
```

#### 1.2 è·å–æ²™ç®±è´¦å·
1. ç™»å½•æ”¯ä»˜å®å¼€æ”¾å¹³å°
2. è¿›å…¥"æ²™ç®±ç¯å¢ƒ" â†’ "æ²™ç®±è´¦å·"
3. è·å–ä¹°å®¶è´¦å·å’Œå¯†ç ç”¨äºæµ‹è¯•

### 2. å¾®ä¿¡æ”¯ä»˜æµ‹è¯•

#### 2.1 ä½¿ç”¨æµ‹è¯•å·
- å¾®ä¿¡æ”¯ä»˜æä¾›æµ‹è¯•å•†æˆ·å·
- å¯ä»¥è¿›è¡Œå°é¢æµ‹è¯•æ”¯ä»˜ï¼ˆ1åˆ†é’±ï¼‰

## ğŸš€ éƒ¨ç½²ä¸Šçº¿

### 1. æœåŠ¡å™¨éƒ¨ç½²

#### 1.1 å‡†å¤‡æœåŠ¡å™¨ç¯å¢ƒ
```bash
# å®‰è£…Java 21
sudo apt update
sudo apt install openjdk-21-jdk

# å®‰è£…MySQL
sudo apt install mysql-server

# é…ç½®é˜²ç«å¢™
sudo ufw allow 8080
sudo ufw allow 443
```

#### 1.2 éƒ¨ç½²åº”ç”¨
```bash
# æ„å»ºåº”ç”¨
./gradlew bootJar

# å¤åˆ¶jaræ–‡ä»¶åˆ°æœåŠ¡å™¨
scp build/libs/socialmeet-0.0.1-SNAPSHOT.jar user@server:/opt/socialmeet/

# å¯åŠ¨åº”ç”¨
java -jar -Dspring.profiles.active=prod /opt/socialmeet/socialmeet-0.0.1-SNAPSHOT.jar
```

### 2. HTTPSé…ç½®

#### 2.1 ç”³è¯·SSLè¯ä¹¦
```bash
# ä½¿ç”¨Let's Encrypt
sudo apt install certbot
sudo certbot certonly --standalone -d yourdomain.com
```

#### 2.2 é…ç½®Nginxåå‘ä»£ç†
```nginx
# /etc/nginx/sites-available/socialmeet
server {
    listen 443 ssl;
    server_name yourdomain.com;
    
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## ğŸ“‹ é…ç½®æ£€æŸ¥æ¸…å•

### âœ… æ”¯ä»˜å®é…ç½®æ£€æŸ¥
- [ ] å¼€æ”¾å¹³å°è´¦å·å·²è®¤è¯
- [ ] åº”ç”¨å·²åˆ›å»ºå¹¶å®¡æ ¸é€šè¿‡
- [ ] æ‰‹æœºç½‘ç«™æ”¯ä»˜åŠŸèƒ½å·²å¼€é€š
- [ ] å¯†é’¥å¯¹å·²ç”Ÿæˆå¹¶é…ç½®
- [ ] å›è°ƒåœ°å€å·²è®¾ç½®
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®

### âœ… å¾®ä¿¡æ”¯ä»˜é…ç½®æ£€æŸ¥
- [ ] å•†æˆ·å¹³å°è´¦å·å·²å®¡æ ¸é€šè¿‡
- [ ] å¼€æ”¾å¹³å°åº”ç”¨å·²åˆ›å»º
- [ ] å¾®ä¿¡æ”¯ä»˜åŠŸèƒ½å·²å…³è”
- [ ] APIå¯†é’¥å·²è®¾ç½®
- [ ] è¯ä¹¦æ–‡ä»¶å·²ä¸‹è½½
- [ ] å›è°ƒActivityå·²åˆ›å»º

### âœ… åº”ç”¨é…ç½®æ£€æŸ¥
- [ ] ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶å·²åˆ›å»º
- [ ] ç¯å¢ƒå˜é‡å·²è®¾ç½®
- [ ] è¯ä¹¦æ–‡ä»¶å·²æ”¾ç½®
- [ ] HTTPSå·²é…ç½®
- [ ] å›è°ƒåœ°å€å¯è®¿é—®

## ğŸš¨ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. å¯†é’¥å®‰å…¨
- âŒ ç»ä¸è¦å°†ç§é’¥æäº¤åˆ°ä»£ç ä»“åº“
- âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯
- âœ… å®šæœŸè½®æ¢APIå¯†é’¥
- âœ… è¯ä¹¦æ–‡ä»¶è®¾ç½®ä¸¥æ ¼æƒé™

### 2. æœåŠ¡å™¨å®‰å…¨
- âœ… ä½¿ç”¨HTTPSåŠ å¯†ä¼ è¾“
- âœ… é…ç½®é˜²ç«å¢™è§„åˆ™
- âœ… å®šæœŸæ›´æ–°ç³»ç»Ÿè¡¥ä¸
- âœ… ç›‘æ§å¼‚å¸¸è®¿é—®

### 3. ä¸šåŠ¡å®‰å…¨
- âœ… éªŒè¯æ‰€æœ‰æ”¯ä»˜å›è°ƒç­¾å
- âœ… æ ¡éªŒè®¢å•é‡‘é¢
- âœ… é˜²æ­¢é‡å¤å¤„ç†
- âœ… è®°å½•æ‰€æœ‰æ”¯ä»˜æ—¥å¿—

---

**é…ç½®å®Œæˆåï¼Œæ‚¨çš„åº”ç”¨å°±å¯ä»¥æ¥å—çœŸå®çš„æ”¯ä»˜äº†ï¼** ğŸ‰

è®°ä½å…ˆåœ¨æ²™ç®±ç¯å¢ƒå……åˆ†æµ‹è¯•ï¼Œç¡®ä¿æ‰€æœ‰æµç¨‹æ­£å¸¸åå†åˆ‡æ¢åˆ°ç”Ÿäº§ç¯å¢ƒã€‚
