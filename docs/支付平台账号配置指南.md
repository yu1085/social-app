# 支付平台账号配置指南

## 🎯 概述

本指南将详细说明如何申请和配置支付宝、微信支付的真实商户账号，以及在应用中进行相关配置。

## 💰 支付宝商户账号申请

### 1. 申请支付宝开发者账号

#### 1.1 注册开放平台账号
1. 访问 [支付宝开放平台](https://open.alipay.com/)
2. 点击"立即入驻" → "开发者入驻"
3. 使用支付宝账号登录
4. 完成开发者认证（个人或企业）

#### 1.2 创建应用
1. 登录开放平台控制台
2. 点击"创建应用" → "移动应用"
3. 填写应用信息：
   - **应用名称**: SocialMeet
   - **应用简介**: 社交聊天应用
   - **应用类型**: Android应用
   - **应用包名**: com.example.myapplication

#### 1.3 配置应用信息
```
应用基本信息：
- 应用图标: 上传应用图标
- 应用截图: 上传应用截图
- 隐私政策: 提供隐私政策链接
- 用户协议: 提供用户协议链接
```

### 2. 获取支付宝密钥信息

#### 2.1 生成应用密钥对
```bash
# 使用支付宝密钥生成工具
# 下载地址: https://opendocs.alipay.com/common/02kipl

# 或使用OpenSSL生成
openssl genrsa -out alipay_private_key.pem 2048
openssl rsa -in alipay_private_key.pem -pubout -out alipay_public_key.pem

# 转换为PKCS#8格式
openssl pkcs8 -topk8 -inform PEM -in alipay_private_key.pem -outform PEM -nocrypt -out alipay_private_key_pkcs8.pem
```

#### 2.2 上传公钥到支付宝
1. 在应用详情页面找到"开发设置"
2. 点击"接口加签方式" → "公钥"
3. 上传刚生成的公钥文件内容
4. 保存后获得"支付宝公钥"

#### 2.3 记录重要信息
```
需要记录的信息：
- APPID: 2021001234567890 (示例)
- 应用私钥: MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwgg...
- 支付宝公钥: MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
```

### 3. 开通手机网站支付功能

#### 3.1 申请功能
1. 在应用管理页面点击"添加功能"
2. 选择"手机网站支付"或"APP支付"
3. 填写相关资料并提交审核

#### 3.2 配置回调地址
```
异步通知地址: https://yourdomain.com/api/recharge/callback/alipay
同步跳转地址: https://yourdomain.com/api/recharge/return/alipay
```

## 💬 微信支付商户账号申请

### 1. 申请微信支付商户号

#### 1.1 注册微信支付商户平台
1. 访问 [微信支付商户平台](https://pay.weixin.qq.com/)
2. 点击"立即注册"
3. 选择"小微商户" 或 "普通商户"（根据业务规模）

#### 1.2 提交资料
```
所需资料：
- 营业执照（企业）或身份证（个人）
- 银行开户许可证
- 法人身份证
- 结算银行卡
- 门店照片（如适用）
```

#### 1.3 签署协议并缴费
- 在线签署《微信支付服务协议》
- 缴纳保证金（通常300元，个人商户可能免缴）

### 2. 获取微信支付配置信息

#### 2.1 获取商户号信息
```
审核通过后获得：
- 商户号(mch_id): 1234567890
- 商户API密钥: 32位字符串
```

#### 2.2 设置API密钥
1. 登录商户平台
2. 进入"账户中心" → "API安全"
3. 设置32位API密钥（用于签名）

#### 2.3 下载证书文件
1. 在"API安全"页面下载商户证书
2. 获得以下文件：
   - apiclient_cert.p12 (商户证书)
   - apiclient_cert.pem (商户证书)
   - apiclient_key.pem (商户私钥)

### 3. 申请微信开放平台账号

#### 3.1 注册开发者账号
1. 访问 [微信开放平台](https://open.weixin.qq.com/)
2. 注册开发者账号并完成认证
3. 缴纳300元认证费用

#### 3.2 创建移动应用
1. 点击"管理中心" → "移动应用"
2. 创建应用并填写信息：
   - **应用名称**: SocialMeet
   - **应用平台**: Android
   - **应用包名**: com.example.myapplication
   - **应用签名**: MD5值

#### 3.3 申请微信支付功能
1. 在应用详情页申请"微信支付"功能
2. 关联已申请的商户号
3. 等待审核通过

## ⚙️ 应用配置

### 1. 后端配置

#### 1.1 创建生产环境配置文件
```yaml
# SocialMeet/src/main/resources/application-prod.yml
spring:
  profiles:
    active: prod
  config:
    include: payment

# 数据库配置（生产环境）
  datasource:
    url: jdbc:mysql://your-prod-db:3306/socialmeet
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}

# 服务器配置
server:
  port: 8080
  servlet:
    context-path: /

# 支付配置
payment:
  alipay:
    app-id: ${ALIPAY_APP_ID}
    private-key: ${ALIPAY_PRIVATE_KEY}
    alipay-public-key: ${ALIPAY_PUBLIC_KEY}
    server-url: https://openapi.alipay.com/gateway.do
    notify-url: https://yourdomain.com/api/recharge/callback/alipay
    return-url: https://yourdomain.com/api/recharge/return/alipay
    
  wechat:
    app-id: ${WECHAT_APP_ID}
    mch-id: ${WECHAT_MCH_ID}
    api-v3-key: ${WECHAT_API_V3_KEY}
    private-key-path: classpath:wechat_private_key.pem
    certificate-serial-number: ${WECHAT_CERT_SERIAL_NO}
    server-url: https://api.mch.weixin.qq.com
    notify-url: https://yourdomain.com/api/recharge/callback/wechat
```

#### 1.2 设置环境变量
```bash
# 创建环境变量文件
# /etc/environment 或 ~/.bashrc

# 支付宝配置
export ALIPAY_APP_ID="2021001234567890"
export ALIPAY_PRIVATE_KEY="MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwgg..."
export ALIPAY_PUBLIC_KEY="MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA..."

# 微信支付配置
export WECHAT_APP_ID="wx1234567890abcdef"
export WECHAT_MCH_ID="1234567890"
export WECHAT_API_V3_KEY="your_32_character_api_v3_key_here"
export WECHAT_CERT_SERIAL_NO="1234567890ABCDEF"

# 数据库配置
export DB_USERNAME="your_db_user"
export DB_PASSWORD="your_db_password"

# 服务器域名
export SERVER_BASE_URL="https://yourdomain.com"
```

#### 1.3 放置证书文件
```bash
# 创建证书目录
mkdir -p SocialMeet/src/main/resources/certs

# 放置微信支付证书
cp apiclient_key.pem SocialMeet/src/main/resources/wechat_private_key.pem
cp apiclient_cert.pem SocialMeet/src/main/resources/wechat_cert.pem

# 设置文件权限
chmod 600 SocialMeet/src/main/resources/*.pem
```

### 2. Android端配置

#### 2.1 添加支付SDK依赖
```kotlin
// app/build.gradle.kts
dependencies {
    // 支付宝SDK
    implementation("com.alipay.sdk:alipay-sdk-android:15.8.11")
    
    // 微信支付SDK
    implementation("com.tencent.mm.opensdk:wechat-sdk-android:6.8.0")
}
```

#### 2.2 配置AndroidManifest.xml
```xml
<!-- app/src/main/AndroidManifest.xml -->
<application>
    <!-- 支付宝支付Activity -->
    <activity
        android:name="com.alipay.sdk.app.H5PayActivity"
        android:configChanges="orientation|keyboardHidden|navigation|screenSize"
        android:exported="false"
        android:screenOrientation="behind"
        android:windowSoftInputMode="adjustResize|stateHidden" />
    
    <activity
        android:name="com.alipay.sdk.app.H5AuthActivity"
        android:configChanges="orientation|keyboardHidden|navigation"
        android:exported="false"
        android:screenOrientation="behind"
        android:windowSoftInputMode="adjustResize|stateHidden" />
    
    <!-- 微信支付Activity -->
    <activity
        android:name=".wxapi.WXPayEntryActivity"
        android:exported="true"
        android:launchMode="singleTop"
        android:theme="@android:style/Theme.Translucent.NoTitleBar" />
</application>

<!-- 权限 -->
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
<uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
```

#### 2.3 创建微信支付回调Activity
```kotlin
// app/src/main/java/com/example/myapplication/wxapi/WXPayEntryActivity.kt
package com.example.myapplication.wxapi

import android.app.Activity
import android.content.Intent
import android.os.Bundle
import com.tencent.mm.opensdk.constants.ConstantsAPI
import com.tencent.mm.opensdk.modelbase.BaseReq
import com.tencent.mm.opensdk.modelbase.BaseResp
import com.tencent.mm.opensdk.openapi.IWXAPI
import com.tencent.mm.opensdk.openapi.IWXAPIEventHandler
import com.tencent.mm.opensdk.openapi.WXAPIFactory

class WXPayEntryActivity : Activity(), IWXAPIEventHandler {
    
    private lateinit var api: IWXAPI
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        api = WXAPIFactory.createWXAPI(this, "your_wechat_app_id")
        api.handleIntent(intent, this)
    }
    
    override fun onNewIntent(intent: Intent?) {
        super.onNewIntent(intent)
        setIntent(intent)
        api.handleIntent(intent, this)
    }
    
    override fun onReq(req: BaseReq?) {
        // 微信请求处理
    }
    
    override fun onResp(resp: BaseResp?) {
        if (resp?.type == ConstantsAPI.COMMAND_PAY_BY_WX) {
            // 处理支付结果
            when (resp.errCode) {
                BaseResp.ErrCode.ERR_OK -> {
                    // 支付成功
                    setResult(RESULT_OK)
                }
                BaseResp.ErrCode.ERR_USER_CANCEL -> {
                    // 用户取消
                    setResult(RESULT_CANCELED)
                }
                BaseResp.ErrCode.ERR_AUTH_DENIED -> {
                    // 支付失败
                    setResult(RESULT_FIRST_USER)
                }
            }
        }
        finish()
    }
}
```

## 🧪 测试配置

### 1. 沙箱环境测试

#### 1.1 支付宝沙箱配置
```yaml
# application-dev.yml
payment:
  alipay:
    app-id: "沙箱应用APPID"
    server-url: https://openapi.alipaydev.com/gateway.do
    # 使用沙箱密钥
```

#### 1.2 获取沙箱账号
1. 登录支付宝开放平台
2. 进入"沙箱环境" → "沙箱账号"
3. 获取买家账号和密码用于测试

### 2. 微信支付测试

#### 2.1 使用测试号
- 微信支付提供测试商户号
- 可以进行小额测试支付（1分钱）

## 🚀 部署上线

### 1. 服务器部署

#### 1.1 准备服务器环境
```bash
# 安装Java 21
sudo apt update
sudo apt install openjdk-21-jdk

# 安装MySQL
sudo apt install mysql-server

# 配置防火墙
sudo ufw allow 8080
sudo ufw allow 443
```

#### 1.2 部署应用
```bash
# 构建应用
./gradlew bootJar

# 复制jar文件到服务器
scp build/libs/socialmeet-0.0.1-SNAPSHOT.jar user@server:/opt/socialmeet/

# 启动应用
java -jar -Dspring.profiles.active=prod /opt/socialmeet/socialmeet-0.0.1-SNAPSHOT.jar
```

### 2. HTTPS配置

#### 2.1 申请SSL证书
```bash
# 使用Let's Encrypt
sudo apt install certbot
sudo certbot certonly --standalone -d yourdomain.com
```

#### 2.2 配置Nginx反向代理
```nginx
# /etc/nginx/sites-available/socialmeet
server {
    listen 443 ssl;
    server_name yourdomain.com;
    
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## 📋 配置检查清单

### ✅ 支付宝配置检查
- [ ] 开放平台账号已认证
- [ ] 应用已创建并审核通过
- [ ] 手机网站支付功能已开通
- [ ] 密钥对已生成并配置
- [ ] 回调地址已设置
- [ ] 环境变量已配置

### ✅ 微信支付配置检查
- [ ] 商户平台账号已审核通过
- [ ] 开放平台应用已创建
- [ ] 微信支付功能已关联
- [ ] API密钥已设置
- [ ] 证书文件已下载
- [ ] 回调Activity已创建

### ✅ 应用配置检查
- [ ] 生产环境配置文件已创建
- [ ] 环境变量已设置
- [ ] 证书文件已放置
- [ ] HTTPS已配置
- [ ] 回调地址可访问

## 🚨 安全注意事项

### 1. 密钥安全
- ❌ 绝不要将私钥提交到代码仓库
- ✅ 使用环境变量管理敏感信息
- ✅ 定期轮换API密钥
- ✅ 证书文件设置严格权限

### 2. 服务器安全
- ✅ 使用HTTPS加密传输
- ✅ 配置防火墙规则
- ✅ 定期更新系统补丁
- ✅ 监控异常访问

### 3. 业务安全
- ✅ 验证所有支付回调签名
- ✅ 校验订单金额
- ✅ 防止重复处理
- ✅ 记录所有支付日志

---

**配置完成后，您的应用就可以接受真实的支付了！** 🎉

记住先在沙箱环境充分测试，确保所有流程正常后再切换到生产环境。
