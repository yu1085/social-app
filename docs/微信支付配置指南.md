# 微信支付配置完整指南

## 📋 概述

本指南将帮助您完成微信支付的完整配置，包括商户号注册、应用创建、功能申请和参数配置。

## 🏪 第一步：注册微信商户号

### 1.1 访问微信支付商户平台
- 打开浏览器访问：https://pay.weixin.qq.com/
- 点击"立即注册"

### 1.2 选择注册类型
- **企业用户**：需要营业执照、对公账户等
- **个体工商户**：需要营业执照、法人身份证等
- **个人用户**：需要身份证、银行卡等（功能有限）

### 1.3 填写基本信息
```
商户名称：SocialMeet支付
商户简称：SocialMeet
经营范围：社交应用服务
联系人：您的姓名
联系电话：您的手机号
邮箱：您的邮箱
```

### 1.4 上传资质文件
- 营业执照（企业/个体户）
- 法人身份证正反面
- 银行开户许可证
- 其他相关资质文件

### 1.5 等待审核
- 审核时间：1-3个工作日
- 审核通过后会收到短信通知

## 🔧 第二步：配置商户号信息

### 2.1 登录商户平台
- 使用注册的手机号和密码登录
- 记录以下重要信息：
  - **商户号（MCH_ID）**：10位数字
  - **商户名称**：用于显示在支付页面

### 2.2 设置API密钥
1. 进入"账户中心" → "API安全"
2. 点击"设置API密钥"
3. 设置32位随机字符串作为API密钥
4. **重要**：记录并保存此密钥，后续无法查看

```
示例API密钥：a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
```

## 📱 第三步：创建微信开放平台应用

### 3.1 注册开放平台账号
- 访问：https://open.weixin.qq.com/
- 使用微信扫码登录
- 完成开发者认证

### 3.2 创建移动应用
1. 进入"管理中心" → "移动应用"
2. 点击"创建移动应用"
3. 填写应用信息：
   ```
   应用名称：SocialMeet
   应用简介：社交应用，提供用户认证和支付服务
   应用官网：https://socialchatai.cloud
   应用包名：com.example.myapplication
   应用签名：C1:78:E6:2D:6F:75:75:A7:8A:4E:CE:C0:FC:CE:A3:85:9E:31:E7:CA
   ```

### 3.3 等待应用审核
- 审核时间：1-3个工作日
- 审核通过后获得**AppID**

## 🔗 第四步：关联微信支付功能

### 4.1 在开放平台关联支付
1. 进入应用详情页面
2. 点击"微信支付"功能
3. 选择"关联已有商户号"
4. 输入商户号（MCH_ID）
5. 确认关联

### 4.2 在商户平台确认关联
1. 登录商户平台
2. 进入"产品中心" → "开发配置"
3. 找到"AppID授权管理"
4. 确认授权关联

## 🔐 第五步：下载证书文件

### 5.1 下载API证书
1. 进入商户平台"账户中心" → "API安全"
2. 点击"下载证书"
3. 下载以下文件：
   - `apiclient_cert.pem` - 商户证书
   - `apiclient_key.pem` - 商户私钥
   - `apiclient_cert.p12` - PKCS12格式证书

### 5.2 获取证书序列号
1. 在证书下载页面查看"证书序列号"
2. 记录此序列号，用于API调用

## ⚙️ 第六步：配置应用参数

### 6.1 更新支付配置文件
编辑 `SocialMeet/src/main/resources/application-payment.yml`：

```yaml
payment:
  wechat:
    app-id: ${WECHAT_APP_ID:your_wechat_app_id}
    mch-id: ${WECHAT_MCH_ID:your_wechat_mch_id}
    api-v3-key: ${WECHAT_API_V3_KEY:your_wechat_api_v3_key}
    private-key-path: ${WECHAT_PRIVATE_KEY_PATH:classpath:wechat_private_key.pem}
    certificate-serial-number: ${WECHAT_CERTIFICATE_SERIAL_NUMBER:your_certificate_serial_number}
    server-url: https://api.mch.weixin.qq.com
    notify-url: ${SERVER_BASE_URL:http://localhost:8080}/api/recharge/callback/wechat
    return-url: ${SERVER_BASE_URL:http://localhost:8080}/api/recharge/return/wechat
```

### 6.2 设置环境变量
创建 `.env` 文件或设置系统环境变量：

```bash
# 微信支付配置
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_MCH_ID=1234567890
WECHAT_API_V3_KEY=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
WECHAT_CERTIFICATE_SERIAL_NUMBER=1234567890ABCDEF1234567890ABCDEF12345678
WECHAT_PRIVATE_KEY_PATH=classpath:wechat_private_key.pem
```

### 6.3 放置证书文件
将下载的证书文件放置到 `SocialMeet/src/main/resources/` 目录下：
- `wechat_private_key.pem` (重命名后的私钥文件)
- `wechat_cert.pem` (重命名后的证书文件)

## 🧪 第七步：测试配置

### 7.1 启动后端服务
```bash
cd SocialMeet
./gradlew bootRun --args="--spring.profiles.active=wechat-real"
```

### 7.2 测试支付接口
```bash
# 测试创建订单
curl -X POST http://localhost:8080/api/recharge/create-order \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "packageId": "package_1",
    "amount": 6.00,
    "coins": 60,
    "paymentMethod": "WECHAT"
  }'
```

### 7.3 测试支付回调
```bash
# 模拟微信支付回调
curl -X POST http://localhost:8080/api/recharge/callback/wechat \
  -H "Content-Type: application/xml" \
  -d '<xml>
    <return_code><![CDATA[SUCCESS]]></return_code>
    <return_msg><![CDATA[OK]]></return_msg>
    <result_code><![CDATA[SUCCESS]]></result_code>
    <mch_id><![CDATA[1234567890]]></mch_id>
    <out_trade_no><![CDATA[ORDER_123456]]></out_trade_no>
    <transaction_id><![CDATA[4200001234567890]]></transaction_id>
    <total_fee>600</total_fee>
    <sign><![CDATA[YOUR_SIGNATURE]]></sign>
  </xml>'
```

## 📱 第八步：配置Android应用

### 8.1 添加微信SDK依赖
在 `app/build.gradle.kts` 中已添加：
```kotlin
implementation 'com.tencent.mm.opensdk:wechat-sdk-android:6.8.0'
```

### 8.2 配置微信支付参数
在 `WechatPayManager.kt` 中更新：
```kotlin
class WechatPayManager {
    private val appId = "wx1234567890abcdef" // 您的微信AppID
    private val partnerId = "1234567890"    // 您的商户号
    
    fun pay(activity: Activity, order: RechargeOrder): PaymentResult {
        val request = PayReq().apply {
            appId = this@WechatPayManager.appId
            partnerId = this@WechatPayManager.partnerId
            prepayId = order.wechatPayInfo?.get("prepayId")
            packageValue = "Sign=WXPay"
            nonceStr = order.wechatPayInfo?.get("nonceStr")
            timeStamp = order.wechatPayInfo?.get("timeStamp")?.toLongOrNull() ?: 0L
            sign = order.wechatPayInfo?.get("sign")
        }
        
        WXAPIFactory.createWXAPI(activity, appId).sendReq(request)
        return PaymentResult.Success("微信支付已启动")
    }
}
```

### 8.3 注册微信支付回调Activity
在 `AndroidManifest.xml` 中添加：
```xml
<activity
    android:name=".payment.WechatPayCallbackActivity"
    android:exported="true"
    android:launchMode="singleTop">
    <intent-filter>
        <action android:name="android.intent.action.VIEW" />
        <category android:name="android.intent.category.DEFAULT" />
        <data android:scheme="wx1234567890abcdef" />
    </intent-filter>
</activity>
```

## 🔍 第九步：验证配置

### 9.1 检查清单
- [ ] 商户号已注册并审核通过
- [ ] 开放平台应用已创建并审核通过
- [ ] 微信支付功能已关联
- [ ] API密钥已设置
- [ ] 证书文件已下载并配置
- [ ] 环境变量已设置
- [ ] 后端服务可正常启动
- [ ] 支付接口可正常调用
- [ ] 回调接口可正常接收

### 9.2 常见问题排查
1. **商户号审核失败**：检查资质文件是否完整、清晰
2. **应用审核失败**：检查应用信息是否真实、完整
3. **支付功能关联失败**：确认商户号和AppID匹配
4. **证书下载失败**：检查商户号状态是否正常
5. **API调用失败**：检查证书文件路径和权限

## 🚀 第十步：上线准备

### 10.1 生产环境配置
1. 更新生产环境域名
2. 配置HTTPS证书
3. 设置生产环境环境变量
4. 测试生产环境支付流程

### 10.2 监控和日志
1. 配置支付日志记录
2. 设置异常监控
3. 定期检查支付状态
4. 备份重要配置

## 📞 技术支持

如果在配置过程中遇到问题，可以：
1. 查看微信支付官方文档
2. 联系微信支付客服
3. 查看我们的错误日志
4. 参考常见问题解答

---

**配置完成后，您的应用就可以接受微信支付了！** 🎉

记住先在测试环境充分验证，确保所有功能正常后再切换到生产环境。
