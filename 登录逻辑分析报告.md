# ç™»å½•é€»è¾‘åˆ†ææŠ¥å‘Š

## ğŸ“‹ å½“å‰ç™»å½•æµç¨‹æ¦‚è¿°

åº”ç”¨é‡‡ç”¨**æ‰‹æœºå· + éªŒè¯ç **çš„ç™»å½•æ–¹å¼ï¼Œæ”¯æŒè‡ªåŠ¨æ³¨å†ŒåŠŸèƒ½ã€‚

## ğŸ”„ å®Œæ•´ç™»å½•æµç¨‹

### 1. å‰ç«¯ç™»å½•æµç¨‹ (LoginActivity.java)

#### 1.1 å‘é€éªŒè¯ç 
```java
private void sendVerificationCode() {
    // 1. éªŒè¯æ‰‹æœºå·æ ¼å¼
    String phone = etPhone.getText().toString().trim();
    if (!isValidPhone(phone)) {
        SafeToast.showShort(this, "è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·");
        return;
    }
    
    // 2. è°ƒç”¨åç«¯APIå‘é€éªŒè¯ç 
    var call = NetworkConfig.getApiService().sendVerificationCode(phone);
    var response = call.execute();
    
    // 3. å¤„ç†å“åº”
    if (response.isSuccessful()) {
        SafeToast.showShort(this, "éªŒè¯ç å·²å‘é€");
    } else {
        // åç«¯ä¸å¯ç”¨æ—¶ï¼Œæ˜¾ç¤ºæµ‹è¯•éªŒè¯ç 
        SafeToast.showLong(this, "åç«¯ä¸å¯ç”¨ï¼Œä½¿ç”¨æµ‹è¯•éªŒè¯ç ï¼š123456");
    }
}
```

#### 1.2 éªŒè¯ç ç™»å½•
```java
private void loginOrRegister() {
    String phone = etPhone.getText().toString().trim();
    String code = etVerificationCode.getText().toString().trim();
    
    // 1. æ£€æŸ¥æ˜¯å¦æ˜¯æµ‹è¯•éªŒè¯ç 
    if ("123456".equals(code)) {
        // æµ‹è¯•æ¨¡å¼ç™»å½•
        var call = NetworkConfig.getApiService().loginWithVerificationCode(phone, code);
        var response = call.execute();
        
        // 2. å¤„ç†ç™»å½•å“åº”
        if (response.isSuccessful()) {
            LoginResponse loginResponse = response.body().getData();
            
            // 3. ä¿å­˜ç™»å½•ä¿¡æ¯
            AuthManager.getInstance(this).saveToken(loginResponse.getToken());
            AuthManager.getInstance(this).saveUserId(loginResponse.getUser().getId());
            
            // 4. è·³è½¬åˆ°æ€§åˆ«é€‰æ‹©ç•Œé¢
            Intent intent = new Intent(this, GenderSelectionActivity.class);
            startActivity(intent);
        }
    }
}
```

### 2. åç«¯ç™»å½•æµç¨‹ (AuthService.java)

#### 2.1 éªŒè¯ç éªŒè¯
```java
public LoginResponse loginWithVerificationCode(String phone, String code) {
    // 1. éªŒè¯éªŒè¯ç 
    if (!verificationCodeService.verifyCode(phone, code)) {
        throw new RuntimeException("éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ");
    }
    
    // 2. æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    User user = userRepository.findByPhone(phone)
            .orElseGet(() -> createUserFromPhone(phone));
    
    // 3. æ›´æ–°ç”¨æˆ·åœ¨çº¿çŠ¶æ€
    user.setIsOnline(true);
    user.setLastSeen(LocalDateTime.now());
    userRepository.save(user);
    
    // 4. ç”ŸæˆJWT token
    String token = jwtUtil.generateToken(user.getUsername(), user.getId());
    
    return new LoginResponse(token, new UserDTO(user));
}
```

#### 2.2 è‡ªåŠ¨ç”¨æˆ·åˆ›å»º
```java
private User createUserFromPhone(String phone) {
    User user = new User();
    user.setId(generateUserId()); // ç”Ÿæˆç”¨æˆ·ID
    user.setPhone(phone);
    user.setUsername("user_" + phone);
    user.setNickname(generateRandomNickname());
    user.setGender("MALE"); // é»˜è®¤ç”·æ€§
    user.setIsActive(true);
    user.setIsOnline(true);
    
    // è‡ªåŠ¨ç”ŸæˆåŸºæœ¬ä¿¡æ¯
    generateBasicInfo(user);
    
    return userRepository.save(user);
}
```

### 3. è®¤è¯ç®¡ç† (AuthManager.java)

#### 3.1 ç™»å½•çŠ¶æ€ç®¡ç†
```java
public class AuthManager {
    // ä¿å­˜ç™»å½•ä¿¡æ¯
    public void saveToken(String token) {
        prefs.edit().putString(KEY_TOKEN, token).apply();
    }
    
    public void saveUserId(Long userId) {
        prefs.edit().putLong(KEY_USER_ID, userId).apply();
    }
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    public boolean isLoggedIn() {
        return getToken() != null && getUserId() != -1;
    }
    
    // è·å–è®¤è¯å¤´
    public String getAuthHeader() {
        String token = getToken();
        return token != null ? "Bearer " + token : null;
    }
}
```

## ğŸ” è®¤è¯æœºåˆ¶

### JWT Token
- **ç”Ÿæˆ**: åç«¯ä½¿ç”¨JwtUtilç”ŸæˆJWT token
- **å­˜å‚¨**: å‰ç«¯ä½¿ç”¨SharedPreferenceså­˜å‚¨
- **ä½¿ç”¨**: æ‰€æœ‰éœ€è¦è®¤è¯çš„APIè¯·æ±‚éƒ½æºå¸¦Bearer token

### éªŒè¯ç æœºåˆ¶
- **å‘é€**: è°ƒç”¨`/api/auth/send-code`æ¥å£
- **éªŒè¯**: åç«¯éªŒè¯ç æœåŠ¡éªŒè¯
- **æµ‹è¯•**: æ”¯æŒæµ‹è¯•éªŒè¯ç "123456"

## ğŸ“± ç”¨æˆ·ç•Œé¢æµç¨‹

1. **LoginActivity** - è¾“å…¥æ‰‹æœºå·å’ŒéªŒè¯ç 
2. **GenderSelectionActivity** - é€‰æ‹©æ€§åˆ«ï¼ˆé¦–æ¬¡ç™»å½•ï¼‰
3. **MainActivity** - ä¸»ç•Œé¢ï¼ˆç™»å½•åï¼‰

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### 1. éªŒè¯ç å®‰å…¨
- éªŒè¯ç æœ‰æ—¶æ•ˆæ€§
- éªŒè¯ç ä½¿ç”¨åè‡ªåŠ¨åˆ é™¤
- æ”¯æŒæµ‹è¯•æ¨¡å¼

### 2. Tokenå®‰å…¨
- JWT tokenåŒ…å«ç”¨æˆ·ä¿¡æ¯
- Tokenç”¨äºAPIè®¤è¯
- æ”¯æŒç™»å‡ºæ¸…é™¤token

### 3. ç”¨æˆ·æ•°æ®å®‰å…¨
- æ‰‹æœºå·ä½œä¸ºå”¯ä¸€æ ‡è¯†
- è‡ªåŠ¨ç”Ÿæˆç”¨æˆ·ä¿¡æ¯
- æ”¯æŒç”¨æˆ·çŠ¶æ€ç®¡ç†

## ğŸ”§ ç‰¹æ®Šå¤„ç†

### 1. æµ‹è¯•æ¨¡å¼
- éªŒè¯ç "123456"ç”¨äºæµ‹è¯•
- åç«¯ä¸å¯ç”¨æ—¶è‡ªåŠ¨å¯ç”¨æµ‹è¯•æ¨¡å¼
- æµ‹è¯•ç”¨æˆ·IDå›ºå®šä¸º86945008

### 2. è‡ªåŠ¨æ³¨å†Œ
- æ‰‹æœºå·ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºç”¨æˆ·
- è‡ªåŠ¨ç”Ÿæˆæ˜µç§°ã€å¹´é¾„ã€ä½ç½®ç­‰ä¿¡æ¯
- é»˜è®¤æ€§åˆ«ä¸ºç”·æ€§

### 3. ç”¨æˆ·IDç”Ÿæˆ
- å½“å‰å¼ºåˆ¶ç”Ÿæˆæµ‹è¯•ç”¨æˆ·ID: 86945008
- å®é™…åº”è¯¥ä½¿ç”¨éšæœºç”Ÿæˆçš„8ä½æ•°å­—ID

## ğŸ“Š æ•°æ®æµå›¾

```
ç”¨æˆ·è¾“å…¥æ‰‹æœºå·
    â†“
å‘é€éªŒè¯ç è¯·æ±‚
    â†“
åç«¯ç”Ÿæˆå¹¶å­˜å‚¨éªŒè¯ç 
    â†“
ç”¨æˆ·è¾“å…¥éªŒè¯ç 
    â†“
éªŒè¯ç éªŒè¯
    â†“
æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    â†“
ç”ŸæˆJWT token
    â†“
ä¿å­˜ç™»å½•ä¿¡æ¯
    â†“
è·³è½¬åˆ°ä¸»ç•Œé¢
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æµ‹è¯•ç”¨æˆ·IDå›ºå®š**: å½“å‰æ‰€æœ‰æ–°ç”¨æˆ·éƒ½ä¼šè·å¾—ID 86945008
2. **éªŒè¯ç æµ‹è¯•**: æ”¯æŒæµ‹è¯•éªŒè¯ç "123456"
3. **è‡ªåŠ¨æ³¨å†Œ**: é¦–æ¬¡ç™»å½•ä¼šè‡ªåŠ¨åˆ›å»ºç”¨æˆ·è´¦æˆ·
4. **é»˜è®¤ä¿¡æ¯**: æ–°ç”¨æˆ·ä¼šè‡ªåŠ¨ç”ŸæˆåŸºæœ¬ä¿¡æ¯

## ğŸ¯ æ€»ç»“

å½“å‰ç™»å½•é€»è¾‘é‡‡ç”¨ç°ä»£åŒ–çš„æ‰‹æœºå·+éªŒè¯ç æ–¹å¼ï¼Œæ”¯æŒè‡ªåŠ¨æ³¨å†Œï¼Œå…·æœ‰è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚ä¸»è¦ç‰¹ç‚¹ï¼š

- âœ… ç®€å•æ˜“ç”¨çš„éªŒè¯ç ç™»å½•
- âœ… è‡ªåŠ¨ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½
- âœ… JWT tokenè®¤è¯æœºåˆ¶
- âœ… æµ‹è¯•æ¨¡å¼æ”¯æŒ
- âœ… ç”¨æˆ·çŠ¶æ€ç®¡ç†

ç™»å½•æˆåŠŸåï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨åº”ç”¨çš„æ‰€æœ‰åŠŸèƒ½ï¼ŒåŒ…æ‹¬æŸ¥çœ‹ç”¨æˆ·å¡ç‰‡ã€é’±åŒ…ç®¡ç†ç­‰ã€‚
